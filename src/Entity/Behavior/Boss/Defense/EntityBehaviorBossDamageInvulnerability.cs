using System;
using Vintagestory.API.Common;
using Vintagestory.API.Common.Entities;
using Vintagestory.API.Datastructures;
using Vintagestory.API.Server;

namespace VsQuest
{
    public class EntityBehaviorBossDamageInvulnerability : EntityBehavior
    {
        public const string InvulnerableUntilKey = "alegacyvsquest:bossdamageinvulnerability:until";

        private ICoreServerAPI sapi;
        private int durationMs;
        private bool visualFlash;

        public int DurationMs => durationMs;

        public EntityBehaviorBossDamageInvulnerability(Entity entity) : base(entity)
        {
        }

        public override string PropertyName() => "bossdamageinvulnerability";

        public override void Initialize(EntityProperties properties, JsonObject attributes)
        {
            base.Initialize(properties, attributes);
            sapi = entity?.Api as ICoreServerAPI;
            durationMs = attributes["durationMs"].AsInt(1000);
            visualFlash = attributes["visualFlash"].AsBool(true);
        }

        public override void OnGameTick(float dt)
        {
            base.OnGameTick(dt);

            if (sapi == null) return;

            long now = sapi.World.ElapsedMilliseconds;
            long invulnerableUntil = entity.WatchedAttributes.GetLong(InvulnerableUntilKey, 0);
            bool isInvulnerable = now < invulnerableUntil;

            // Visual flash effect
            if (visualFlash && isInvulnerable)
            {
                float flashIntensity = 0.5f + 0.5f * (float)Math.Sin(now / 100.0);
                entity.WatchedAttributes.SetFloat("entityBrightness", flashIntensity);
            }
            else
            {
                entity.WatchedAttributes.SetFloat("entityBrightness", 0);
            }
        }

        // Called from Harmony patch to check if damage should be blocked
        public static bool ShouldBlockDamage(EntityAgent entity, long now)
        {
            if (entity == null) return false;
            long invulnerableUntil = entity.WatchedAttributes.GetLong(InvulnerableUntilKey, 0);
            return now < invulnerableUntil;
        }

        // Called from Harmony patch to start invulnerability after damage
        public static void OnDamageReceived(EntityAgent entity, int durationMs)
        {
            if (entity?.Api is ICoreServerAPI sapi)
            {
                long now = sapi.World.ElapsedMilliseconds;
                entity.WatchedAttributes.SetLong(InvulnerableUntilKey, now + durationMs);
                entity.WatchedAttributes.MarkPathDirty(InvulnerableUntilKey);
            }
        }

        public override void OnEntityDeath(DamageSource damageSourceForDeath)
        {
            base.OnEntityDeath(damageSourceForDeath);
            // Reset invulnerability on death so respawned boss can take damage
            entity.WatchedAttributes.RemoveAttribute(InvulnerableUntilKey);
        }
    }
}
